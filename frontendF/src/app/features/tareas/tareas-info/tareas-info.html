<ion-header class="ion-no-border">
  <ion-toolbar class="bg-white">
    <ion-buttons slot="start">
      <ion-button fill="clear" size="small" (click)="goBack()">
        <ion-icon name="arrow-back-outline" class="text-xl text-gray-700"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="text-center">
      <span class="font-semibold text-gray-800">Detalle de Tarea</span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="isAdmin" fill="clear" size="small" (click)="eliminarTarea()">
        <ion-icon name="trash-outline" class="text-xl text-red-500"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!isAdmin && (tareaAdminSeleccionada?.usuarioasignado_id == null || tareaAdminSeleccionada?.usuarioasignado_id === 0)"
                  fill="clear" size="small" (click)="asignarATarea($event)" [disabled]="asignando">
        <ion-icon name="person-add-outline" class="text-xl text-green-500"></ion-icon>
      </ion-button>
      <!-- Botón de acción de tarea (Iniciar / Finalizar / Reaperturar para admin) -->
      <ion-button *ngIf="textoBotonAccion()" fill="clear" size="small" (click)="ejecutarAccionPrincipal()" [color]="colorBotonAccion()">
        {{ textoBotonAccion() }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-50">
  <div class="p-4 space-y-4">
    <!-- Card de información principal -->
    <div class="bg-white rounded-2xl p-4 shadow-sm">
      <!-- Badges superiores -->
      <div class="flex flex-wrap gap-2 mb-3">
        <!-- Estado -->
        <span class="px-3 py-1 rounded-full text-xs font-medium"
              [ngClass]="{
                'bg-yellow-100 text-yellow-700': tareaAdminSeleccionada?.estado === 'Pendiente',
                'bg-blue-100 text-blue-700': tareaAdminSeleccionada?.estado === 'En progreso',
                'bg-green-100 text-green-700': tareaAdminSeleccionada?.estado === 'Completada'
              }">
          {{tareaAdminSeleccionada?.estado || 'Pendiente'}}
        </span>
        <!-- Categoría -->
        <span class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 flex items-center gap-1">
          <ion-icon name="grid-outline" class="text-xs"></ion-icon>
          {{tareaAdminSeleccionada?.Categoria || 'Sin categoría'}}
        </span>
        <!-- Sucursal -->
        <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 flex items-center gap-1">
          <ion-icon name="business-outline" class="text-xs"></ion-icon>
          {{tareaAdminSeleccionada?.sucursal || 'Sin sucursal'}}
        </span>
      </div>

      <!-- Título -->
      <h1 class="text-lg font-bold text-gray-900 mb-1">
        {{tareaAdminSeleccionada?.titulo || 'Sin título'}}
      </h1>
      
      <!-- Descripción -->
      <p class="text-sm text-gray-500 mb-4">
        {{tareaAdminSeleccionada?.descripcion || 'Sin descripción'}}
      </p>

      <!-- Fecha y Hora -->
      <div class="flex items-center gap-6 text-sm text-gray-600">
        <div class="flex items-center gap-2">
          <ion-icon name="calendar-outline" class="text-gray-400"></ion-icon>
          <span>{{tareaAdminSeleccionada?.fechaAsignacion || '--/--/----'}}</span>
        </div>
        <div class="flex items-center gap-2">
          <ion-icon name="time-outline" class="text-gray-400"></ion-icon>
          <span>{{tareaAdminSeleccionada?.horaprogramada || '--:--'}} - {{tareaAdminSeleccionada?.horafin || '--:--'}}</span>
        </div>
      </div>
    </div>

    <!-- Observaciones / Evidencias (solo mostrar cuando la tarea esté completada) -->
    <div *ngIf="tareaAdminSeleccionada?.estado === 'Completada'" class="bg-white rounded-2xl p-4 shadow-sm">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700">Observaciones de cierre</span>
        <span class="text-sm font-bold text-gray-900">Completada</span>
      </div>

      <div class="text-sm text-gray-700 mb-3">
        <p *ngIf="tareaAdminSeleccionada?.observaciones">{{ tareaAdminSeleccionada?.observaciones }}</p>
        <p *ngIf="!tareaAdminSeleccionada?.observaciones" class="text-xs text-gray-400">No hay observaciones registradas.</p>
      </div>

      <div *ngIf="tareaAdminSeleccionada?.imagenes" class="mt-3">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Evidencias</h3>
        <div class="flex gap-3 overflow-x-auto">
          <img *ngFor="let img of parseImagenes(tareaAdminSeleccionada?.imagenes)" [src]="getEvidenceUrl(img)" class="h-32 rounded-lg object-cover" />
        </div>
      </div>
    </div>

    <!-- Si no está completada, mostrar progreso como antes -->
    <div *ngIf="tareaAdminSeleccionada?.estado !== 'Completada'" class="bg-white rounded-2xl p-4 shadow-sm">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700">Progreso</span>
        <span class="text-sm font-bold text-gray-900">{{progresoGeneral.porcentaje | number:'1.0-0'}}%</span>
      </div>
      <!-- Barra de progreso -->
      <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
        <div class="h-2 rounded-full transition-all duration-300"
             [ngClass]="{
               'bg-green-500': progresoGeneral.porcentaje >= 100,
               'bg-blue-500': progresoGeneral.porcentaje < 100 && progresoGeneral.porcentaje > 0,
               'bg-gray-300': progresoGeneral.porcentaje === 0
             }"
             [style.width.%]="progresoGeneral.porcentaje"></div>
      </div>
      <p class="text-xs text-gray-500 text-center">
        {{progresoGeneral.completadas}} de {{progresoGeneral.total}} subtareas completadas
      </p>
    </div>

    <!-- Sección de Subtareas -->
    <div class="bg-white rounded-2xl p-4 shadow-sm">
      <!-- Header de subtareas -->
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
          <ion-icon name="list-outline" class="text-lg text-gray-600"></ion-icon>
          <h2 class="text-base font-semibold text-gray-900">Subtareas ({{progresoGeneral.total}})</h2>
        </div>
        <!-- Botón agregar - solo admin -->
        <button *ngIf="isAdmin" 
                class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                (click)="abrirModalCrearSubtarea()">
          <fa-icon [icon]="faPlus" class="text-sm"></fa-icon>
          <span>Agregar</span>
        </button>
      </div>

      <!-- Empty state -->
      <div *ngIf="subtareas.length === 0" class="py-8 text-center">
        <div class="flex flex-col items-center">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
            <ion-icon name="checkbox-outline" class="text-3xl text-gray-400"></ion-icon>
          </div>
          <p class="text-gray-500 font-medium mb-1">No hay subtareas creadas</p>
          <p class="text-xs text-gray-400 mb-4">Las subtareas te ayudan a organizar mejor esta actividad</p>
          <button *ngIf="isAdmin" 
                  class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors"
                  (click)="abrirModalCrearSubtarea()">
            <fa-icon [icon]="faPlus" class="text-xs"></fa-icon>
            Crear primera subtarea
          </button>
        </div>
      </div>

      <!-- Lista de subtareas -->
      <div *ngIf="subtareas.length > 0" class="space-y-3">
        <div *ngFor="let subtarea of subtareas; let i = index" 
             class="flex items-start gap-3 p-3 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors"
             [ngClass]="{
               'bg-green-50': subtarea.estado === 'Completada',
               'bg-blue-50': subtarea.estado === 'En progreso',
               'bg-gray-50': subtarea.estado !== 'Completada' && subtarea.estado !== 'En progreso'
             }"
             (click)="navegarASubtarea(subtarea)">
          <!-- Indicador de línea de tiempo -->
            <div class="flex flex-col items-center">
              <div class="w-6 h-6 rounded-full flex items-center justify-center"
                   [ngClass]="{
                     'bg-green-100': subtarea.estado === 'Completada',
                     'bg-blue-100': subtarea.estado === 'En progreso',
                     'bg-gray-100': subtarea.estado !== 'Completada' && subtarea.estado !== 'En progreso'
                   }">
                <ion-icon *ngIf="subtarea.estado === 'Completada'" name="checkmark" class="text-xs text-green-600"></ion-icon>
                <ion-icon *ngIf="subtarea.estado === 'En progreso'" name="play" class="text-xs text-blue-600"></ion-icon>
                <ion-icon *ngIf="subtarea.estado !== 'Completada' && subtarea.estado !== 'En progreso'" name="ellipse" class="text-xs text-gray-400"></ion-icon>
              </div>
              <div *ngIf="i < subtareas.length - 1" class="w-0.5 h-12 mt-1"
                   [ngClass]="{
                     'bg-green-200': subtarea.estado === 'Completada',
                     'bg-blue-200': subtarea.estado === 'En progreso',
                     'bg-gray-200': subtarea.estado !== 'Completada' && subtarea.estado !== 'En progreso'
                   }"></div>
            </div>

          <!-- Contenido de la subtarea -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
              <h3 class="text-sm font-semibold line-clamp-1"
                  [ngClass]="{
                    'text-green-800': subtarea.estado === 'Completada',
                    'text-gray-900': subtarea.estado !== 'Completada'
                  }">{{subtarea.titulo}}</h3>
              <!-- Badge de estado -->
              <span class="text-[10px] px-2 py-0.5 rounded-full"
                    [ngClass]="{
                      'bg-green-100 text-green-700': subtarea.estado === 'Completada',
                      'bg-blue-100 text-blue-700': subtarea.estado === 'En progreso',
                      'bg-yellow-100 text-yellow-700': subtarea.estado === 'Pendiente'
                    }">
                {{subtarea.estado}}
              </span>
            </div>
            
            <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{subtarea.descripcion || 'Sin descripción'}}</p>
            
            <!-- Info adicional (usuario asignado, hora, evidencias) -->
            <div class="flex items-center gap-3 mt-2 text-[10px] text-gray-400">
              <span class="flex items-center gap-1" *ngIf="subtarea.usuarioasignado">
                <ion-icon name="person-outline"></ion-icon>
                {{subtarea.usuarioasignado}}
              </span>
              <span class="flex items-center gap-1" *ngIf="subtarea.horaprogramada">
                <ion-icon name="time-outline"></ion-icon>
                {{subtarea.horaprogramada}}
              </span>
              <!-- Indicador de evidencias -->
              <span class="flex items-center gap-1 text-green-600" *ngIf="subtarea.evidencia_count && subtarea.evidencia_count > 0">
                <ion-icon name="images-outline"></ion-icon>
                {{subtarea.evidencia_count}} evidencia(s)
              </span>
            </div>
          </div>

          <!-- Chevron -->
          <ion-icon name="chevron-forward-outline" class="text-gray-400 mt-1"></ion-icon>
        </div>
      </div>
    </div>
  </div>
</ion-content>
