<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
  <!-- Header -->
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <a routerLink="/dashboard" 
           class="p-2 rounded-lg bg-white shadow-sm hover:bg-gray-50 transition-colors"
           pTooltip="Volver al Dashboard" tooltipPosition="right">
          <fa-icon [icon]="['far', 'arrow-left']" class="text-gray-600"></fa-icon>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
            <fa-icon [icon]="['far', 'users']" class="text-blue-600"></fa-icon>
            Gestión de Usuarios
          </h1>
          <p class="text-gray-500 text-sm">Administra los usuarios del sistema</p>
        </div>
      </div>
      
      <button pButton 
              type="button" 
              class="p-button-primary"
              (click)="abrirModalCrear()">
        <fa-icon [icon]="['far', 'user-plus']" class="mr-2"></fa-icon>
        Nuevo Usuario
      </button>
    </div>

    <!-- Tabla de usuarios -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <p-table [value]="usuarios" 
               [loading]="loading"
               [paginator]="true" 
               [rows]="10"
               [rowsPerPageOptions]="[5, 10, 25]"
               [showCurrentPageReport]="true"
               currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
               styleClass="p-datatable-striped p-datatable-sm">
        
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60px">ID</th>
            <th>Usuario</th>
            <th style="width: 100px">Rol</th>
            <th style="width: 130px">Estado</th>
            <th style="width: 100px" class="text-center">Intentos</th>
            <th style="width: 160px">Último intento</th>
            <th style="width: 160px">Bloqueado hasta</th>
            <th style="width: 180px" class="text-center">Acciones</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-usuario>
          <tr>
            <td class="font-mono text-gray-500">{{ usuario.id }}</td>
            <td>
              <div class="flex items-center gap-2">
                <fa-icon [icon]="['far', 'user']" class="text-gray-400"></fa-icon>
                <span class="font-medium">{{ usuario.username }}</span>
              </div>
            </td>
            <td>
              <p-tag [value]="usuario.role === 'admin' ? 'Admin' : 'Usuario'" 
                     [severity]="usuario.role === 'admin' ? 'info' : 'secondary'">
              </p-tag>
            </td>
            <td>
              <p-tag [value]="getEstadoTexto(usuario)" 
                     [severity]="getSeverity(usuario)">
              </p-tag>
            </td>
            <td class="text-center">
              <span [class]="usuario.failedAttempts > 0 ? 'text-orange-600 font-semibold' : 'text-gray-400'">
                {{ usuario.failedAttempts }}
              </span>
            </td>
            <td class="text-sm text-gray-500">
              {{ formatearFecha(usuario.lastAttemptTime) }}
            </td>
            <td class="text-sm text-gray-500">
              {{ formatearFecha(usuario.lockoutUntil) }}
            </td>
            <td>
              <div class="flex justify-center gap-1">
                <!-- Botón activar/desactivar -->
                <button pButton 
                        type="button" 
                        [class]="usuario.isPermanentlyLocked ? 'p-button-success p-button-text p-button-sm' : 'p-button-warning p-button-text p-button-sm'"
                        (click)="toggleEstado(usuario)"
                        [pTooltip]="usuario.isPermanentlyLocked ? 'Activar usuario' : 'Desactivar usuario'"
                        tooltipPosition="top">
                  <fa-icon [icon]="['far', usuario.isPermanentlyLocked ? 'check' : 'xmark']"></fa-icon>
                </button>
                
                <!-- Botón desbloquear (solo si tiene intentos o bloqueo temporal) -->
                @if (usuario.failedAttempts > 0 || usuario.lockoutUntil) {
                  <button pButton 
                          type="button" 
                          class="p-button-info p-button-text p-button-sm"
                          (click)="desbloquearCuenta(usuario)"
                          pTooltip="Desbloquear cuenta"
                          tooltipPosition="top">
                    <fa-icon [icon]="['far', 'lock-open']"></fa-icon>
                  </button>
                }
                
                <!-- Botón eliminar -->
                <button pButton 
                        type="button" 
                        class="p-button-danger p-button-text p-button-sm"
                        (click)="eliminarUsuario(usuario)"
                        pTooltip="Eliminar usuario"
                        tooltipPosition="top">
                  <fa-icon [icon]="['far', 'trash']"></fa-icon>
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              <fa-icon [icon]="['far', 'users']" class="text-4xl text-gray-300 mb-2"></fa-icon>
              <p>No hay usuarios registrados</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<!-- Modal para crear usuario -->
<app-modal-crear-usuario (usuarioCreado)="onUsuarioCreado()"></app-modal-crear-usuario>

<!-- Toast para notificaciones -->
<p-toast></p-toast>

<!-- Dialog de confirmación -->
<p-confirmDialog appendTo="body" styleClass="custom-confirm" [dismissableMask]="true"></p-confirmDialog>
